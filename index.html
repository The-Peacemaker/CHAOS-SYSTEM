<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOICE OF CAMPUS</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📣</text></svg>">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <!-- Login Overlay -->
    <div id="login-overlay">
        <div class="login-box">
            <div class="logo" style="font-size: 2rem; margin-bottom: 1rem;">VOICE OF CAMPUS</div>
            
            <!-- Login Form -->
            <div id="login-form">
                <h2>LOGIN</h2>
                <input type="email" id="login-email" placeholder="EMAIL (e.g. alice@example.com)">
                <input type="password" id="login-pass" placeholder="PASSWORD">
                <button onclick="login()">ENTER CHAOS</button>
                <div class="login-toggle" onclick="toggleAuthMode()">New here? Register</div>
            </div>

            <!-- Register Form -->
            <div id="register-form" class="hidden">
                <h2>JOIN US</h2>
                <input type="text" id="reg-name" placeholder="FULL NAME">
                <input type="email" id="reg-email" placeholder="EMAIL">
                <input type="password" id="reg-pass" placeholder="PASSWORD">
                <select id="reg-role">
                    <option value="student">STUDENT</option>
                    <option value="professor">PROFESSOR</option>
                </select>
                <button onclick="register()">REGISTER</button>
                <div class="login-toggle" onclick="toggleAuthMode()">Already have an account? Login</div>
            </div>
            <p id="auth-error" style="color: var(--accent-4); font-weight: bold; margin-top: 1rem;"></p>
        </div>
    </div>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="logo">
            VOICE OF CAMPUS
        </div>
        <ul class="nav-links">
            <li class="nav-item active" onclick="switchTab('dashboard')">
                HUB
            </li>
            <li class="nav-item" onclick="switchTab('wall')">
                THE WALL
            </li>
            <li class="nav-item" onclick="switchTab('elections')">
                VOTING BOOTH
            </li>
            <li class="nav-item" onclick="switchTab('leaderboard')">
                LEADERBOARD
            </li>
            <li class="nav-item nav-item-sos" onclick="switchTab('sos')">
                PANIC BUTTON
            </li>
        </ul>
        
        <div class="user-profile">
            <div style="font-size: 0.8rem; margin-bottom: 5px;">IDENTITY:</div>
            <div style="display: flex; flex-direction: column; gap: 5px;">
                <strong id="user-name-display" style="background: var(--black); color: var(--white); padding: 2px 5px;">...</strong>
                <span class="role-badge" id="user-role-display">...</span>
                <span class="karma-badge" id="user-karma-display">KARMA: ...</span>
            </div>
            <button class="secondary" onclick="logout()" style="margin-top: 1rem; width: 100%;">LOGOUT</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        
        <!-- Header -->
        <div class="header-bar">
            <h2 id="page-title">HUB</h2>
            <button class="secondary" onclick="refreshAll()">
                REFRESH
            </button>
        </div>

        <!-- DASHBOARD TAB -->
        <div id="tab-dashboard" class="tab-content">
            <div class="card welcome-card">
                <h3>WELCOME TO THE CHAOS</h3>
                <p>ONE HUB. ONE VOICE. NO FILTER.</p>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
                <div class="card action-card" onclick="switchTab('wall')">
                    <h4>THE WALL</h4>
                    <p class="text-muted">SPEAK YOUR MIND. EARN KARMA.</p>
                </div>
                <div class="card action-card" onclick="switchTab('elections')">
                    <h4>VOTING BOOTH</h4>
                    <p class="text-muted">DEMOCRACY (MAYBE).</p>
                </div>
                <div class="card action-card" onclick="switchTab('leaderboard')">
                    <h4>LEADERBOARD</h4>
                    <p class="text-muted">WHO RULES THE CAMPUS?</p>
                </div>
            </div>
        </div>

        <!-- THE WALL TAB (Combined Feedback/Blogs) -->
        <div id="tab-wall" class="tab-content hidden">
            <!-- Create Post -->
            <div id="create-post-form" class="card">
                <h3>POST TO THE WALL</h3>
                <input type="text" id="post-title" placeholder="TITLE">
                <textarea id="post-body" rows="3" placeholder="WHAT'S ON YOUR MIND?"></textarea>
                
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <select id="post-type">
                        <option value="general">GENERAL</option>
                        <option value="complaint">COMPLAINT</option>
                        <option value="suggestion">SUGGESTION</option>
                        <option value="rant">RANT</option>
                    </select>
                </div>

                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 1rem; cursor: pointer;">
                    <div class="custom-checkbox">
                        <input type="checkbox" id="post-anon" style="display: none;">
                        <div class="checkbox-graphic"></div>
                    </div>
                    <span>POST ANONYMOUSLY</span>
                </label>
                <button onclick="submitPost()">POST IT</button>
            </div>

            <!-- List -->
            <div id="wall-list">Loading...</div>
        </div>

        <!-- VOTING TAB -->
        <div id="tab-elections" class="tab-content hidden">
            <!-- Professor: Create Poll -->
            <div id="prof-election-form" class="card hidden">
                <h3>CREATE POLL / ELECTION</h3>
                <input type="text" id="el-title" placeholder="TITLE">
                <input type="text" id="el-desc" placeholder="DESCRIPTION">
                <textarea id="el-options" rows="3" placeholder="OPTIONS (COMMA SEPARATED)"></textarea>
                <select id="el-type" style="margin-bottom: 1rem;">
                    <option value="poll">OPINION POLL</option>
                    <option value="election">OFFICIAL ELECTION</option>
                    <option value="decision">DECISION MAKING</option>
                </select>
                <button onclick="createElection()">INITIATE</button>
            </div>

            <!-- List -->
            <div id="election-list">Loading...</div>
        </div>

        <!-- LEADERBOARD TAB -->
        <div id="tab-leaderboard" class="tab-content hidden">
            <div class="card">
                <h3>CAMPUS LEGENDS</h3>
                <p>EARN KARMA BY POSTING AND GETTING UPVOTES.</p>
            </div>
            <div id="leaderboard-list">Loading...</div>
        </div>

        <!-- SOS TAB -->
        <div id="tab-sos" class="tab-content hidden">
            <!-- Student: Trigger -->
            <div id="student-sos-btn" class="card hidden" style="text-align: center; border: none; background: transparent; box-shadow: none;">
                
                <div style="margin-bottom: 2rem; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto;">
                    <label style="font-weight: 900; font-size: 1.2rem; color: var(--red); display: block; margin-bottom: 0.5rem;">WHERE ARE YOU?</label>
                    <input type="text" id="sos-location" placeholder="e.g. Library 2nd Floor, Canteen..." 
                           style="border: 4px solid var(--red); font-size: 1.2rem; font-weight: bold; color: var(--red);">
                </div>

                <button class="sos-btn" onclick="triggerSOS()">
                    EMERGENCY!<br>SOS!
                </button>
                <p id="sos-status" style="margin-top: 2rem; font-weight: 900; font-size: 1.5rem; background: var(--black); color: var(--white); display: inline-block; padding: 0.5rem;"></p>
            </div>

            <!-- Professor: Log -->
            <div id="prof-sos-log" class="hidden">
                <h3>EMERGENCY LOG</h3>
                <div id="sos-list">Loading...</div>
            </div>
        </div>

    </main>

    <!-- AI Assistant Widget -->
    <div id="ai-widget">
        <div id="ai-icon" onclick="toggleChat()">
            <i class="fas fa-robot"></i>
        </div>
        <div id="ai-chat-window" class="hidden">
            <div class="ai-header">
                <span>EMO BOY</span>
                <span onclick="toggleChat()" style="cursor: pointer;">X</span>
            </div>
            <div id="chat-history">
                <div class="chat-msg bot">
                    <div class="msg-content">Hi! I'm here to help with studies or just listen. How are you feeling?</div>
                </div>
            </div>
            <div class="ai-input-area">
                <input type="text" id="chat-input" placeholder="Type here..." onkeypress="handleChatKey(event)">
                <button onclick="sendChat()">SEND</button>
            </div>
        </div>
    </div>

    <script>
        // --- State & Config ---
        const API_URL = 'http://localhost:3000/api';
        let currentUser = null;
        let authToken = localStorage.getItem('token');

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            if (authToken) {
                // Try to restore session (simplified: just use stored user data if available, or re-login)
                const storedUser = localStorage.getItem('user');
                if (storedUser) {
                    currentUser = JSON.parse(storedUser);
                    document.getElementById('login-overlay').classList.add('hidden');
                    updateUIForUser();
                    refreshAll();
                } else {
                    // Token exists but no user data? Logout to be safe
                    logout();
                }
            }

            // Custom Checkbox Logic
            const anonCheck = document.getElementById('post-anon');
            const graphic = document.querySelector('.checkbox-graphic');
            if(anonCheck && graphic) {
                anonCheck.addEventListener('change', (e) => {
                    graphic.classList.toggle('checked', e.target.checked);
                });
            }
        });

        // --- Auth Functions ---
        function toggleAuthMode() {
            document.getElementById('login-form').classList.toggle('hidden');
            document.getElementById('register-form').classList.toggle('hidden');
            document.getElementById('auth-error').innerText = '';
        }

        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-pass').value;
            const errorEl = document.getElementById('auth-error');

            try {
                const res = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();

                if (!res.ok) throw new Error(data.message);

                authToken = data.token;
                currentUser = data.user;
                
                localStorage.setItem('token', authToken);
                localStorage.setItem('user', JSON.stringify(currentUser));

                document.getElementById('login-overlay').classList.add('hidden');
                updateUIForUser();
                refreshAll();

            } catch (err) {
                errorEl.innerText = err.message;
            }
        }

        async function register() {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-pass').value;
            const role = document.getElementById('reg-role').value;
            const errorEl = document.getElementById('auth-error');

            try {
                const res = await fetch(`${API_URL}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password, role })
                });
                const data = await res.json();

                if (!res.ok) throw new Error(data.message);

                // Auto login or ask to login? Let's ask to login
                alert('Registration successful! Please login.');
                toggleAuthMode();

            } catch (err) {
                errorEl.innerText = err.message;
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            authToken = null;
            currentUser = null;
            location.reload();
        }

        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            };
        }

        function updateUIForUser() {
            document.getElementById('user-name-display').innerText = currentUser.name;
            document.getElementById('user-role-display').innerText = currentUser.role.toUpperCase();
            document.getElementById('user-karma-display').innerText = `KARMA: ${currentUser.karma}`;

            if (currentUser.role === 'professor') {
                document.getElementById('prof-election-form').classList.remove('hidden');
                document.getElementById('student-sos-btn').classList.add('hidden');
                document.getElementById('prof-sos-log').classList.remove('hidden');
            } else {
                document.getElementById('prof-election-form').classList.add('hidden');
                document.getElementById('student-sos-btn').classList.remove('hidden');
                document.getElementById('prof-sos-log').classList.add('hidden');
            }
        }

        function refreshAll() {
            if (!authToken) return;
            loadPosts();
            loadElections();
            loadLeaderboard();
            loadSOS();
        }

        // --- Navigation ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeNav = document.querySelector(`.nav-item[onclick="switchTab('${tabName}')"]`);
            if(activeNav) activeNav.classList.add('active');

            const titles = {
                'dashboard': 'HUB',
                'wall': 'THE WALL',
                'elections': 'VOTING BOOTH',
                'leaderboard': 'LEADERBOARD',
                'sos': 'PANIC BUTTON'
            };
            document.getElementById('page-title').innerText = titles[tabName] || 'HUB';
        }

        // --- THE WALL (Posts) ---
        async function loadPosts() {
            const list = document.getElementById('wall-list');
            list.innerHTML = '<p>Loading...</p>';
            try {
                const res = await fetch(`${API_URL}/posts`, { headers: getHeaders() });
                const posts = await res.json();
                
                if(posts.length === 0) {
                    list.innerHTML = '<p>No posts yet. Be the first!</p>';
                    return;
                }

                list.innerHTML = posts.map(post => `
                    <div class="card post-card type-${post.type}">
                        <div class="post-header">
                            <span class="post-type">${post.type.toUpperCase()}</span>
                            <span class="post-author">${post.author}</span>
                            <span class="post-date">${new Date(post.date).toLocaleDateString()}</span>
                        </div>
                        <h4>${post.title}</h4>
                        <p>${post.body}</p>
                        <div class="post-actions">
                            <button class="vote-btn up" onclick="votePost('${post._id}', 'up')">▲ ${post.upvotes}</button>
                            <button class="vote-btn down" onclick="votePost('${post._id}', 'down')">▼ ${post.downvotes}</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                list.innerHTML = '<p>Error loading posts.</p>';
            }
        }

        async function submitPost() {
            const title = document.getElementById('post-title').value;
            const body = document.getElementById('post-body').value;
            const type = document.getElementById('post-type').value;
            const isAnon = document.getElementById('post-anon').checked;

            if(!title || !body) return alert('Fill in all fields!');

            await fetch(`${API_URL}/posts`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({
                    title, body, type, isAnonymous: isAnon
                })
            });

            document.getElementById('post-title').value = '';
            document.getElementById('post-body').value = '';
            loadPosts();
            // Refresh user to get new karma
            // In a real app we'd fetch user profile again, but let's just increment locally for now or ignore
        }

        async function votePost(id, type) {
            const res = await fetch(`${API_URL}/posts/${id}/vote`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({ type })
            });
            if (!res.ok) {
                const data = await res.json();
                alert(data.message || 'Vote failed');
            }
            loadPosts();
        }

        // --- ELECTIONS ---
        async function loadElections() {
            const list = document.getElementById('election-list');
            try {
                const res = await fetch(`${API_URL}/elections`, { headers: getHeaders() });
                const elections = await res.json();
                
                list.innerHTML = elections.map(el => `
                    <div class="card">
                        <div class="post-header">
                            <span class="post-type">${el.type ? el.type.toUpperCase() : 'POLL'}</span>
                            <span class="post-status">${el.status || ''}</span>
                            ${currentUser.role === 'professor' ? `<button class="secondary" style="color: var(--red); border-color: var(--red); padding: 0.2rem 0.5rem; font-size: 0.8rem;" onclick="deleteElection('${el._id}')">DELETE</button>` : ''}
                        </div>
                        <h4>${el.title}</h4>
                        <p>${el.description}</p>
                        <div class="options-grid">
                            ${el.options.map(opt => `
                                <button class="option-btn" onclick="voteElection('${el._id}', '${opt.id}')">
                                    ${opt.text} <span class="vote-count">(${opt.votes})</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                list.innerHTML = '<p>Error loading elections.</p>';
            }
        }

        async function createElection() {
            const title = document.getElementById('el-title').value;
            const desc = document.getElementById('el-desc').value;
            const options = document.getElementById('el-options').value;
            const type = document.getElementById('el-type').value;

            if(!title || !options) return alert('Title and Options required!');

            await fetch(`${API_URL}/elections`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({ title, description: desc, options, type })
            });

            document.getElementById('el-title').value = '';
            document.getElementById('el-desc').value = '';
            document.getElementById('el-options').value = '';
            loadElections();
        }

        async function voteElection(electionId, optionId) {
            const res = await fetch(`${API_URL}/elections/vote`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({ electionId, optionId })
            });
            if (!res.ok) {
                const data = await res.json();
                alert(data.message || 'Vote failed');
            }
            loadElections();
        }

        async function deleteElection(id) {
            if(!confirm('Are you sure you want to delete this election?')) return;
            
            const res = await fetch(`${API_URL}/elections/${id}`, {
                method: 'DELETE',
                headers: getHeaders()
            });
            
            if(res.ok) {
                loadElections();
            } else {
                alert('Failed to delete election');
            }
        }

        // --- LEADERBOARD ---
        async function loadLeaderboard() {
            const list = document.getElementById('leaderboard-list');
            try {
                const res = await fetch(`${API_URL}/leaderboard`, { headers: getHeaders() });
                let users = await res.json();
                
                if (users.length === 0) {
                    list.innerHTML = '<p>No data available.</p>';
                    return;
                }

                const top3 = users.slice(0, 3);
                const rest = users.slice(3);

                let html = '';

                // Podium Section
                html += '<div class="leaderboard-podium">';
                if (users[1]) html += `<div class="podium-card rank-2"><div class="podium-rank">#2</div><div class="podium-name">${users[1].name}</div><div class="podium-score">${users[1].karma || 0} PTS</div></div>`;
                if (users[0]) html += `<div class="podium-card rank-1"><div class="podium-rank">#1</div><div class="podium-name">${users[0].name}</div><div class="podium-score">${users[0].karma || 0} PTS</div><div style="font-size: 3rem; margin-top: 10px;">👑</div></div>`;
                if (users[2]) html += `<div class="podium-card rank-3"><div class="podium-rank">#3</div><div class="podium-name">${users[2].name}</div><div class="podium-score">${users[2].karma || 0} PTS</div></div>`;
                html += '</div>';

                // List Section
                html += '<div class="leaderboard-rest">';
                html += rest.map((u, index) => `
                    <div class="leaderboard-item">
                        <span class="rank">#${index + 4}</span>
                        <span class="name">${u.name}</span>
                        <span class="score">${u.karma || 0} KARMA</span>
                    </div>
                `).join('');
                html += '</div>';
                
                list.innerHTML = html;
            } catch (e) {
                list.innerHTML = '<p>Error loading leaderboard.</p>';
            }
        }

        // --- SOS ---
        async function loadSOS() {
            if(currentUser.role !== 'professor') return;
            const list = document.getElementById('sos-list');
            try {
                const res = await fetch(`${API_URL}/sos`, { headers: getHeaders() });
                const alerts = await res.json();
                list.innerHTML = alerts.map(a => `
                    <div class="card" style="border-color: var(--red);">
                        <h4 style="color: var(--red);">SOS ALERT</h4>
                        <p><strong>FROM:</strong> ${a.author}</p>
                        <p><strong>LOC:</strong> ${a.location}</p>
                        <p><strong>TIME:</strong> ${new Date(a.timestamp).toLocaleTimeString()}</p>
                    </div>
                `).join('');
            } catch (e) {}
        }

        async function triggerSOS() {
            const status = document.getElementById('sos-status');
            const locationInput = document.getElementById('sos-location');
            const location = locationInput.value;

            if(!location) {
                alert("Please tell us where you are!");
                locationInput.focus();
                return;
            }

            status.innerText = 'SENDING ALERT...';
            
            await fetch(`${API_URL}/sos`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({ location })
            });

            status.innerText = 'HELP IS ON THE WAY!';
            status.style.color = 'var(--red)';
        }

        // --- AI CHAT ---
        function toggleChat() {
            const win = document.getElementById('ai-chat-window');
            win.classList.toggle('hidden');
        }

        function handleChatKey(e) {
            if(e.key === 'Enter') sendChat();
        }

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const text = input.value;
            if(!text) return;

            const history = document.getElementById('chat-history');
            history.innerHTML += `<div class="chat-msg user"><div class="msg-content">${text}</div></div>`;
            input.value = '';
            history.scrollTop = history.scrollHeight;

            const loadingId = 'loading-' + Date.now();
            history.innerHTML += `<div class="chat-msg bot" id="${loadingId}"><div class="msg-content loading-dots">...</div></div>`;
            history.scrollTop = history.scrollHeight;

            try {
                const res = await fetch(`${API_URL}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }, // Chat doesn't strictly need auth but good to have
                    body: JSON.stringify({ message: text })
                });
                const data = await res.json();
                
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) loadingEl.remove();

                history.innerHTML += `<div class="chat-msg bot"><div class="msg-content">${data.response}</div></div>`;
                history.scrollTop = history.scrollHeight;
            } catch (e) {
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) loadingEl.remove();
            }
        }

    </script>
</body>
</html>